<!DOCTYPE html>
<!-- 
This file for github pages
see https://labneurocogdevel.github.io/cardtask
-->
<html>
  <head>
    <meta charset="UTF-8">
    <title>Card Task experiments</title>
    <!-- all of this also in ./templates/exp.html -->
    <link rel="stylesheet" href="static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="static/js/jspsych/css/jspsych.css" type="text/css" />
    <link rel="stylesheet" href="static/css/style.css" type="text/css" />
    <link id="feedback" rel="stylesheet" href="static/css/feedback.css" type="text/css" />
    <style>
	.select {background: lightyellow; font-size: larger;}
    </style>
    <script src="static/lib/jquery-3.4.1.min.js" type="text/javascript"> </script>
    <script src="static/lib/underscore-min.js" type="text/javascript"> </script>
    <script src="static/lib/backbone-min.js" type="text/javascript"> </script>
    <script src="static/lib/d3.v3.min.js" type="text/javascript"> </script>
    <script src="static/js/jspsych/jspsych.js" type="text/javascript"></script>
    <script src="static/js/jspsych/plugins/jspsych-instructions.js" type="text/javascript"></script>
    <script src="static/js/jspsych/plugins/jspsych-html-keyboard-response.js" type="text/javascript"></script>
    <script src="static/js/jspsych/plugins/jspsych-survey-text.js" type="text/javascript"></script>
    <script src="static/js/utils.js" type="text/javascript"> </script>
    <script src="static/js/task.js" type="text/javascript"> </script>

    <script type="text/javascript">
      // redfine cards for testing

      
     /*
      CARDS relevant to testing:
       'p11_1D': new Card('❖', 'blue', LOWCOST , CARDWIN,  1),
       'p11_1R': new Card('✢', 'red' , HIGHCOST, CARDWIN,  1),
       'test_0R': new Card('0', 'red' , HIGHCOST, CARDWIN,  0),
       'test_0B': new Card('0', 'blue', LOWCOST , CARDWIN,  0),
      */
      var fbkstim = function(trial) {
	// setup win vs nowin feedback color and message
	var prev=jsPsych.data.get().last(1).values()[0]
	var msg=(prev.win > 0)?("+"+prev.win):"0";
	var color=(prev.win > 0)?"win":"nowin";
	var card = CARDS[prev.picked]
	return(
	  "<p class='feedback sym'>" + card.sym +"</p>" +
	  "<p class='feedback cost'> Paid: -" + prev.cost +"</p>" +
	  "<p class='feedback " + color + "'>Won: " + msg + "</p>" +
	  "<p class='feedback net "+color+"'>Net: " +
		(prev.win - prev.cost) + "</p>"+
          "<p class='feedback'>Total: " + totalPoints() + "</p>"+
          "<p class='feedback'><br><b>Push the space bar to see the next pair</b></p>"
	 )}
      
      // stolen from https://stackoverflow.com/questions/16994662/count-animation-from-number-a-to-b
      function animateValue(obj, start, end, duration, text) {
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          obj.html(text + Math.floor(progress * (end - start) + start));
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }
      
      fbk={}
      fbk['orig'] = fbk['cnt'] = fbk['coin'] = feedback
      MAXCNTDUR=1000 //ms
      fbk['cnt'].on_load = function(trial) {
	const prev=jsPsych.data.get().last(1).values()[0]
        const net = (prev.win - prev.cost)
	if(net>0) {
	  animateValue($('.net'), 0, net, net/CARDWIN*MAXCNTDUR, "NET:")
	} 
      }
 
      // dummy trial that lasts 0 seconds
      function dummy(c){
	  return({
	      type: 'html-keyboard-response',
	      stimulus: '',
              trial_duration: 0,
              on_finish: function(data) {
                 data.cost  = CARDS[c].cost
                 data.p     = CARDS[c].p
                 data.win   = CARDS[c].score()
                 data.score = data.win - data.cost;
                 data.picked = c;
      }})}
      function fulltrial() {
	t = mktrial("p11_1D", "test_1R")
	jsPsych.init({timeline: [t, feedback], display_element: jsp});
      }
      function mkfeedback(c) {
	dummycard=dummy(c)
	// push fake data and run feedback slide with given card
	jsPsych.init({timeline: [dummycard, feedback], display_element: jsp});
      }
      
      // play with feedback
      function fbk_set(n){
          // indicator
	  $('.fbk').attr('class','fbk')
	  $('#'+n).attr('class','fbk select')
          // change style sheet
          $('link[id="feedback"]').attr('href', 'static/css/feedback.css');
	  if(n == "cnt") {
	    $('link[id="feedback"]').attr('href', 'static/css/feedback-cnt.css');
	  }
	  feedback = fbk[n]
	  console.log('updateing feedback', n, feedback)
      }
    </script>

  </head>

  <body>
    fbk settings: 
      <a class="fbk select" id=orig onclick="fbk_set('orig')">orig</a> 
      <a class=fbk id=cnt onclick="fbk_set('cnt')">cnt</a> 
      <a class=fbk id=coin onclick="fbk_set('coin')">coin</a>
    <br>
    <a href="#" onclick="fulltrial()">full</a> |
    feedback only:
     <a href="#" onclick="mkfeedback('p11_1R')">1r</a> , 
     <a href="#" onclick="mkfeedback('p11_1D')">1</a> ,
     <a href="#" onclick="mkfeedback('test_0B')">0</a> 
    <br><br>
    <div id="jsp"> </div>

  </body>
</html>
